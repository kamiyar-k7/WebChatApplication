@page "/signup"
@layout StartLayout
@inject IUserServices _userservice
@inject NavigationManager _navmanager


<BootStrapModal @ref="bootStrapModal" url="/signin">
    <headtext>
        <p class="">Successfull!</p>
    </headtext>
    <bodytext>
        <p class="">U will Dicrect To The SignIn Page Atomatically in : @time Seconds</p>
    </bodytext>
</BootStrapModal>

<div class="container">
    <div class="row justify-content-center align-items-center h-100" style="min-height:100vh;">

        <div class="col-12 col-sm-7 col-md-6 col-lg-5 col-xl-4">

            <EditForm Model="userdto" OnValidSubmit="HandleSignUp">
                <ValidationSummary />
                <DataAnnotationsValidator />

                <div class="bg-secondary rounded-3 p-4 p-sm-5 my-4 mx-3">


                    <h4 class="text-center mb-4 text-uppercase fw-bold"> Sign Up</h4>

                    <div class="form-group">

                        <label for="UserName">UserName</label>
                        <InputText class="form-control" @bind-Value="userdto.UserName"></InputText>
                        @if (!string.IsNullOrEmpty(GetErrorForField("UserName")))
                        {
                            <div class="text-danger small fw-bold" style="margin-top: 0.25rem; background-color:aliceblue">
                                @GetErrorForField("UserName")
                            </div>
                        }
                    </div>
                    <div class="form-group">

                        <label for="UserEmail">UserEmail</label>
                        <InputText class="form-control" @bind-Value="userdto.UserEmail"></InputText>
                        @if (!string.IsNullOrEmpty(GetErrorForField("UserEmail")))
                        {
                            <div class="text-danger small fw-bold" style="margin-top: 0.25rem; background-color:aliceblue">
                                @GetErrorForField("UserEmail")
                            </div>
                        }
                    </div>
                    <div class="form-group">

                        <label for="Password">Password</label>
                        <InputText type="password" class="form-control" @bind-Value="userdto.Password"></InputText>
                        @if (!string.IsNullOrEmpty(GetErrorForField("Password")))
                        {
                            <div class="text-danger small fw-bold" style="margin-top: 0.25rem; background-color:aliceblue">
                                @GetErrorForField("Password")
                            </div>
                        }
                    </div>

                    <br />
                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert alert-danger">
                            <p>
                                @message
                            </p>
                        </div>
                    }
                    <div class="d-flex flex-column flex-md-row gap-3">

                        <SpinnerButton isbuttonworking=BSpinnerWorking>
                            Submit
                        </SpinnerButton>
                        <a href="/" class="btn btn-light py-3 w-100">Cancel</a>
                    </div>
                    <br />
                    <a href="/signIn" class="text-info">Alreade Have An Acoount?</a>

                </div>
            </EditForm>


        </div>


    </div>
</div>






@code {
    private UserSignUpDto userdto = new UserSignUpDto();
    private string message = string.Empty;
    private bool BSpinnerWorking = false;
    private BootStrapModal bootStrapModal;
    private int time = 5;
    private Timer? _timer;
    private Dictionary<string, List<string>> dictionaryErrors = new Dictionary<string, List<string>>();


    public async Task HandleSignUp()
    {
        try
        {
            dictionaryErrors.Clear();
            BSpinnerWorking = true;


            await _userservice.SignUp(userdto);

            await bootStrapModal.OpenModal();

            time = 5;
            while (time > 0)
            {
                await Task.Delay(1000);

                time--;
                InvokeAsync(StateHasChanged);
            }

            await bootStrapModal.CloseModal();

            _navmanager.NavigateTo("/signIn");



        }
        catch (ApiException ex)
        {

            BSpinnerWorking = false;
            var result = await ExceptionHandler.HandleApiException(ex);

            if (result is Dictionary<string, List<string>> errors)
            {

                // Handle the dictionary of errors
                foreach (var error in errors)
                {
                    string fieldName = error.Key; 


                    if (dictionaryErrors.ContainsKey(fieldName))
                    {

                        dictionaryErrors[fieldName].AddRange(error.Value);
                        continue;
                    }


                    dictionaryErrors[fieldName] = error.Value;
                }
              
            }
            else if (result is ExeptionDto exceptionDto)
            {
                // Handle the exception DTO
                message = $"{exceptionDto.Message}, {exceptionDto.StatusCode}";
               
            }

        }

    }

    private string GetErrorForField(string fieldName)
    {
     
        if (dictionaryErrors.ContainsKey(fieldName))
        {
            return  string.Join("!\n ", dictionaryErrors[fieldName]);
        }
        return string.Empty;
    }
}





